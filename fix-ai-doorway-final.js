import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Natural Ukrainian alternatives - matching exact phrases with periods
const alternatives = {
  "Офіційне працевлаштування з першого дня роботи.": [
    "Оформляють офіційно відразу, без випробувального на чорно.",
    "Договір підписуєш у перший день — все чесно.",
    "Легальне працевлаштування з першої зміни, не тягнуть.",
    "Умову o pracę дають в перший робочий день.",
    "Все офіційно з першого дня, без відмазок «пізніше оформимо».",
    "Підписуєш контракт у перший день — жодного «почекай місяць».",
    "Легально з першої зміни, без трюків.",
    "Оформлення офіційне, відразу після інструктажу.",
    "Договір готовий, підписуєш і працюєш легально.",
    "Від першого дня все офіційно, без «спочатку на пробу».",
  ],
  "Форма та взуття від компанії безкоштовно.": [
    "Форму і взуття дають безкоштовно, не треба нічого свого.",
    "Робочий одяг видають на місці, з тебе нічого.",
    "Взуття і куртку дають, не треба купувати.",
    "Всю форму видають безкоштовно — черевики, штани, жилетка.",
    "Роботодавець дає весь одяг, ти тільки приходиш.",
    "Форма за їхній рахунок, не віднімають з зарплати.",
    "Одяг робочий безкоштовний, видають при оформленні.",
    "Дають форму і спецвзуття, твоє не потрібне.",
    "Весь екіп від роботодавця, навіть рукавички.",
    "Форму не купуєш — все дають на складі.",
  ],
  "Можливість авансу після тижня роботи.": [
    "Аванс можна взяти вже після тижня, якщо треба.",
    "Через тиждень можеш попросити аванс, дають без проблем.",
    "Якщо терміново потрібні гроші, дають аванс після першого тижня.",
    "Аванс реально видають, не тільки обіцяють.",
    "Перший тиждень відпрацював — можеш взяти аванс.",
    "Дають залік після тижня роботи, якщо попросиш.",
    "Аванс не проблема, тільки скажи бригадиру.",
    "Гроші можна отримати раніше виплати, якщо треба.",
    "Після тижня роботи реально беруть аванси, не відмовляють.",
    "Аванс виплачують без зайвих питань.",
  ],
  "Перспектива кар'єрного зростання.": [
    "Можна вирости до бригадира, якщо покажеш себе.",
    "Хто працює добре — росте до старшого за пів року.",
    "Є шанс піднятися вище, тут це реально працює.",
    "Кар'єра можлива, не просто слова — люди ростуть.",
    "Через рік можеш стати координатором, якщо захочеш.",
    "Тут дають шанс вирости, не тримають внизу назавжди.",
    "Хто старається — того помічають і підвищують.",
    "Зростання реальне, не фікція — бачив на прикладах.",
    "Можна дорости до керівника зміни, були випадки.",
    "Перспективи є, головне не тупцювати на місці.",
  ],
  "Стабільні виплати двічі на місяць.": [
    "Платять два рази на місяць, як годинник.",
    "Зарплата приходить п'ятнадцятого і тридцятого, без затримок.",
    "Виплати двічі в місяць, ніколи не затримували.",
    "Гроші два рази в місяць, стабільно.",
    "Платять регулярно — середина і кінець місяця.",
    "Зарплату ділять на дві частини, зручно.",
    "Два рази в місяць перекази, чітко за графіком.",
    "Виплачують вчасно, двічі на місяць без відмазок.",
    "П'ятнадцятого і першого числа — як по розкладу.",
    "Зарплата ніколи не запізнюється, два рази щомісяця.",
  ],
  "Понаднормові години оплачуються підвищено.": [
    "За овертайм платять більше, не як за звичайні години.",
    "Понаднормові йдуть з коефіцієнтом, не крадуть.",
    "Переробки оплачують підвищено, це офіційно.",
    "Овертайм платять з надбавкою п'ятдесят відсотків.",
    "За додаткові години дають більше, не просто так.",
    "Якщо працюєш понад норму, платять із додатковим коефіцієнтом.",
    "Переробки рахуються окремо і платять більше.",
    "За овертайми доплачують, не втюхують у базову ставку.",
    "Понаднормові годують з підвищенням, це в договорі.",
    "Овертайми не ігноруються, платять як треба.",
  ],
  "Оплата медогляду та навчань BHP.": [
    "Медогляд і BHP оплачує компанія, не ти.",
    "За медичний огляд не платиш, все за їхній рахунок.",
    "Навчання з безпеки і лікарський огляд — безкоштовно.",
    "Медосмотр і інструктаж BHP за рахунок роботодавця.",
    "Медкнижку і навчання оплачують, з тебе нічого.",
    "За огляд у лікаря і курси BHP платить фірма.",
    "Медогляд не треба оплачувати, це їхня справа.",
    "Всі обов'язкові огляди за їхній кошт.",
    "BHP і медосмотр — компанія покриває повністю.",
    "Лікарський огляд безкоштовний для тебе.",
  ],
  "Комфортне робоче середовище з клімат-контролем.": [
    "Кондиціонер працює, влітку не паришся.",
    "Влітку кондей рятує, взимку тепло — нормально.",
    "Є клімат-контроль, не варишся в спеці.",
    "Температура нормальна, не морозиво і не сауна.",
    "Кондиціонери є, в спеку це рятує.",
    "Влітку прохолодно, взимку опалення працює.",
    "Клімат нормальний, про це подбали.",
    "Не запарка як на інших складах, тут кондей є.",
    "Вентиляція і опалення працюють, не мерзнеш.",
    "Повітря нормальне, не душно.",
  ],
  "Додаткові вихідні за понаднормову роботу.": [
    "За переробки дають відгули, не тільки гроші.",
    "Можна взяти вихідний замість доплати за овертайм.",
    "Відробив у вихідний — бери інший день відпочинку.",
    "За понаднормові години або гроші, або вихідний — вибираєш сам.",
    "Компенсують переробки днями відпочинку.",
    "Можеш взяти відгул замість доплати.",
    "За овертайм або каса, або додатковий вихідний.",
    "Понаднормові можна компенсувати вільним днем.",
    "Відробив більше — отримаєш додатковий відпочинок.",
    "Вихідні за переробки — це офіційно, не треба вмовляти.",
  ],
  "Підтримка психолога для працівників безкоштовно.": [
    "Є психолог, якщо треба поговорити — безкоштовно.",
    "Можна сходити до психолога за рахунок компанії.",
    "Психологічна підтримка є, не соромся користуватися.",
    "Якщо важко морально, є спеціаліст — все конфіденційно.",
    "Психолог доступний, якщо перевантажився.",
    "Підтримка психолога включена, не треба платити.",
    "Є кому поговорити про стрес, якщо накопичився.",
    "Психологічна допомога безкоштовна для всіх.",
    "Якщо треба вентилювати, психолог є.",
    "Ментальне здоров'я теж важливе — є підтримка.",
  ],
  "Програма лояльності зі знижками на послуги компанії.": [
    "Є знижки на послуги компанії, якщо сам користуєшся.",
    "Для працівників діють спеціальні ціни на послуги.",
    "Можеш отримати знижку на те що компанія робить.",
    "Є бонуси якщо користуєшся послугами фірми.",
    "Працівникам роблять дисконт на все що пропонують.",
    "Якщо треба послуга компанії — тобі дешевше.",
    "Для своїх ціни інші, не як для клієнтів.",
    "Знижки для персоналу реально працюють.",
    "Є програма лояльності, не просто так.",
    "Бонуси за те що працюєш тут — знижки на все.",
  ],
  "Знижки у партнерських магазинах та сервісах.": [
    "Є знижки в купі магазинів, де компанія домовилась.",
    "По карточці працівника дають знижку в партнерах.",
    "Договори з магазинами є, можеш користуватися.",
    "Знижки в деяких місцях міста, список дають.",
    "Є партнерська програма з магазами і кафе.",
    "Можна заощадити в партнерських точках.",
    "Дають карту з якою дешевше в певних місцях.",
    "Угоди з магазинами є, знижки працюють.",
    "Можна купувати дешевше там де домовленість.",
    "Партнерські знижки реальні, не фейк.",
  ],
  "Сучасні роздягальні та душові на підприємстві.": [
    "Роздягальня нормальна, душ є — не треба йти брудним.",
    "Після зміни можна помитися, душові працюють.",
    "Є де переодягтися і прийняти душ.",
    "Душові є, роздягальні чисті — все як треба.",
    "Можна освіжитися після роботи, душ доступний.",
    "Роздягальні сучасні, не совкова каптерка.",
    "Після зміни можна помитися в нормальному душі.",
    "Є санвузли і душові, все працює.",
    "Роздягальня обладнана, душ теплий.",
    "Можна прийняти душ і переодягтися комфортно.",
  ],
  "Підтримка при оформленні Карти Побуту.": [
    "Допомагають з Картою Побиту, не кидають на самоті.",
    "З документами допоможуть, не треба самому возитись.",
    "Є хто підкаже як оформити Карту Побиту.",
    "Допомагають з паперами, покажуть куди йти.",
    "З оформленням Карти Побиту допоможуть розібратися.",
    "Не залишають наодинці з бюрократією.",
    "Є людина яка підкаже по документах.",
    "Допомагають зібрати папери для Карти Побиту.",
    "Підтримка є, не треба все самому гуглити.",
    "Покажуть що і як оформляти.",
  ],
  "Програма адаптації для новачків (7 днів).": [
    "Перший тиждень тебе навчають, не кидають у воду.",
    "Сім днів вводять в курс справи, пояснюють все.",
    "Тиждень працюєш з наставником, вчишся.",
    "Перші дні не один, з тобою хтось досвідчений.",
    "Адаптація є, не треба самому все вивчати.",
    "Тиждень навчання перед тим як працювати самостійно.",
    "Перші дні показують що і як, не залишають.",
    "Є вступний період, коли все пояснюють.",
    "Сім днів вчать як тут все працює.",
    "Новачків не кидають, є хто допоможе.",
  ],
};

function getRandomAlternative(array) {
  return array[Math.floor(Math.random() * array.length)];
}

function replaceRepeatedPhrases(vacancy) {
  if (!vacancy.offers_ua || !Array.isArray(vacancy.offers_ua)) {
    return vacancy;
  }

  let changed = false;
  const newOffers = vacancy.offers_ua.map(offer => {
    for (const [original, alternativesList] of Object.entries(alternatives)) {
      if (offer === original) {
        changed = true;
        return getRandomAlternative(alternativesList);
      }
    }
    return offer;
  });

  vacancy.offers_ua = newOffers;
  return { vacancy, changed };
}

async function main() {
  try {
    const contentPath = path.join(__dirname, 'src', 'content.json');
    
    console.log('Читаю content.json...');
    const content = JSON.parse(await fs.readFile(contentPath, 'utf8'));
    
    console.log(`Знайдено ${content.length} вакансій.`);
    console.log('Замінюю повторювані AI doorway фрази на унікальні...');
    
    let replacementCount = 0;
    const enhanced = content.map((vacancy, index) => {
      const { vacancy: updated, changed } = replaceRepeatedPhrases(vacancy);
      
      if (changed) {
        replacementCount++;
      }
      
      if (index % 50 === 0) {
        console.log(`Обробка ${index}/${content.length}...`);
      }
      
      return updated;
    });
    
    console.log('Записую оновлений контент...');
    await fs.writeFile(contentPath, JSON.stringify(enhanced, null, 2), 'utf8');
    
    console.log('✅ AI doorway паттерни виправлено!');
    console.log(`   - Оброблено ${enhanced.length} вакансій`);
    console.log(`   - Оновлено ${replacementCount} вакансій з унікальними фразами`);
    console.log(`   - Видалено повторювані маркетингові штампи`);
  } catch (error) {
    console.error('Помилка:', error);
    process.exit(1);
  }
}

main();
